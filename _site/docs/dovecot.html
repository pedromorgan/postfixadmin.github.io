<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Dovecot | PostfixAdmin - Web amdin interface for postfix mailserver</title>
<link rel="icon" href="/img/favicon.ico" type="image/x-icon" /> 
<link rel="shortcut icon" href="/img/favicon.png" type="image/png" />

<link href="bootstrap-3.3.7-dist/css/bootstrap.min.css" rel="stylesheet">
<link href="bootstrap-3.3.7-dist/css/bootstrap-theme.min.css" rel="stylesheet">
<link href="css/jekyll-github.css" rel="stylesheet">

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="bootstrap-3.3.7-dist/js/bootstrap.min.js" type="text/javascript"></script>


<link href="css/pfa.17.css" rel="stylesheet">


</head>

<body>
    
    

    
<nav class="navbar">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <div id="main-logo"><a class="navbar-brand" href="index.html"><span class="logo-postfix">postfix</span><span class="logo-dot">.</span><span class="logo-admin">admin</span></a>
            </div>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
            <ul class="nav navbar-nav">
				
                <li >
                    <a href="index.html"><span class="glyphicon glyphicon-home" aria-hidden="true"></span> Home</a></li>
                    
                <li >
                    <a href="install.html"><span class="glyphicon glyphicon-education" aria-hidden="true"></span> Install</a></li>

                    
                 <li >
                    <a href="postfix.html"><span class="glyphicon glyphicon-th-list" aria-hidden="true"></span> Postfix</a></li>
                    
                 <li class="active">
                    <a href="dovecot.html"><span class="glyphicon glyphicon-th-list" aria-hidden="true"></span> Dovecot</a></li>
                    
                 <li >
                    <a href="security.html"><span class="glyphicon glyphicon-th-list" aria-hidden="true"></span> Security</a></li>
                    
                        
           
				<li >
                    <a href="faq.html"><span class="glyphicon glyphicon-screenshot" aria-hidden="true"></span> FAQ</a></li>
                    
                    
                <li >
                    <a href="vacation.html"><span class="glyphicon glyphicon-sound-stereo" aria-hidden="true"></span> Vacation</a></li>
                
      
               
    
                    
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Project <span class="caret"></span></a>
                    <ul class="dropdown-menu" role="menu">
                        <li><a href="https://github.com/postfixadmin/" target="github"><span class="glyphicon glyphicon-object-align-horizontal" aria-hidden="true"></span> PostfixAdmin @ github</a></li>
                        <li class="divider"></li>
                        <li class="dropdown-header">PostfixAdmin</li>
                               <li><a href="https://github.com/postfixadmin/postfixadmin" target="github"><span class="glyphicon glyphicon-floppy-disk" aria-hidden="true"></span> Source code</a></li>
                            <li><a href="https://github.com/postfixadmin/postfixadmin/issues" starget="github"><span class="glyphicon glyphicon-th-list" aria-hidden="true"></span> Issues</a></li>
       
                        <li class="dropdown-header">postfixadmin.github.io</li>
                        <li><a href="https://github.com/postfixadmin/postfixadmin.github.io" target="github"><span class="glyphicon glyphicon-floppy-disk" aria-hidden="true"></span> Source code</a></li>
                        <li><a href="https://github.com/postfixadmin/postfixadmin.github.io/issues" starget="github"><span class="glyphicon glyphicon-th-list" aria-hidden="true"></span> Issues</a></li>
                    </ul>
                </li>
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Support <span class="caret"></span></a>
                    <ul class="dropdown-menu" role="menu">
                        <li><a href="https://gitter.im/postfixadmin/community" target="_blank">Chat on gitter.im</a></li>
                        <li><a href="http://stackoverflow.com/questions/tagged/postfixadmin" target="_blank">PostfixAdmin at StackOverflow</a></li>
                    </ul>
                <li>
                 
            </ul>
        </div>
    </div>
</nav>


    <div class="container revel-docs">
        <div class="row">
            <div class="col-md-3">
               
            </div>

            <div class="col-md-9">
                <div class="page-header">
                    <a href="https://github.com/postfixadmin/postfixadmin.github.io/edit/master/docs/dovecot.md" class="improve-page btn dbtn-info" target="_blank"><span class="glyphicon glyphicon-edit" aria-hidden="true"></span> Improve Page</a>
                    <h1>Dovecot</h1>
                </div>
                <div class="main">
                    <p>Complete Dovecot documentation:</p>

<ul>
  <li><a href="http://wiki.dovecot.org/Quota">Quota</a></li>
  <li>http://wiki.dovecot.org/Quota/Dict</li>
  <li>http://www.opensourcehowto.org/how-to/mysql/mysql-users-postfixadmin-postfix-dovecot–squirrelmail-with-userprefs-stored-in-mysql.html</li>
</ul>

<p>Here are the relevant parts of Dovecot v2.1.x configuration for Postfixadmin setup.</p>

<p>Please refer to Dovecot documentation for complete information.</p>

<p>The setup gets userdb and passdb info from MySQL as well as quotas, and 
uses dict backend to store used quotas as key=value pairs so that they can
be viewed real-time in Postfixadmin.</p>

<h2 id="dovecot-setup">Dovecot setup</h2>

<p>A basic <code class="highlighter-rouge">/etc/dovecot/dovecot.conf</code> is as follows, this was generated using ‘dovecot -n’ on a vanilla install and then
changing to talk to a PostgreSQL or MySQL database.</p>

<h1 id="begin-etcdovecotdovecotconf">BEGIN /etc/dovecot/dovecot.conf:</h1>
<h1 id="change-this-to-where-your-mail-root-is-this-needs-to-match-whatever-structure-postfix-expects">Change this to where your mail root is, this needs to match whatever structure postfix expects….</h1>

<p>mail_location = maildir:/var/mail/vmail/%u/</p>

<p>namespace inbox {
  inbox = yes
  location = 
  mailbox Drafts {
    special_use = \Drafts
  }
  mailbox Junk {
    special_use = \Junk
  }
  mailbox Sent {
    special_use = \Sent
  }
  mailbox “Sent Messages” {
    special_use = \Sent
  }
  mailbox Trash {
    special_use = \Trash
  }
  prefix = 
}</p>

<p>protocols = “imap pop3”</p>
<h1 id="change-to-no-if-you-dont-have-ssl-certkeys-and-comment-out-ssl_certssl_key">change to ‘no’ if you don’t have ssl cert/keys, and comment out ssl_cert/ssl_key</h1>
<p>ssl = yes 
ssl_cert = &lt;/etc/dovecot/private/dovecot.pem
ssl_key = &lt;/etc/dovecot/private/dovecot.pem</p>

<h1 id="login-is-for-outlook-express-smtpd-auth">login is for outlook express smtpd auth</h1>
<p>auth_mechanisms = plain login</p>

<h1 id="if-youre-having-trouble-try-uncommenting-these-">If you’re having trouble, try uncommenting these :</h1>
<p>#auth_debug = yes
#auth_debug_passwords = yes</p>

<p>userdb { 
    driver = sql
    args = /etc/dovecot/dovecot-sql.conf 
}</p>

<p>passdb { 
    driver = sql
    args = /etc/dovecot/dovecot-sql.conf 
}</p>

<h1 id="uncomment-this-if-you-want-postfix-to-be-able-to-do-smtpd-auth-through-dovecot">Uncomment this if you want Postfix to be able to do smtpd auth through dovecot</h1>
<h1 id="at-a-minimum-postfix-probably-needs--smtpd_sasl_type--dovecot">At a minimum Postfix probably needs : smtpd_sasl_type = dovecot</h1>
<h1 id="and-additionally-smtpd_sasl_path--privateauth">And additionally: smtpd_sasl_path = private/auth</h1>
<p>#service auth {</p>
<h1 id="unix_listener-varspoolpostfixprivateauth-">unix_listener /var/spool/postfix/private/auth {</h1>
<h1 id="mode--0660">mode = 0660</h1>
<h1 id="user--postfix">user = postfix</h1>
<h1 id="group--postfix">group = postfix</h1>
<h1>}</h1>
<p>#}</p>

<h1 id="needs-to-match-postfix-virtual_uid_maps">Needs to match Postfix virtual_uid_maps</h1>
<p>first_valid_uid = 1001</p>

<h1 id="allow-plaintext-auth-change-to-yes-to-block-plaintext-passwords">allow plaintext auth (change to ‘yes’ to block plaintext passwords)</h1>
<p>disable_plaintext_auth = no</p>

<p>#END</p>

<ol>
  <li>
    <h2 id="dovecot-sql-setup">Dovecot *sql setup</h2>
  </li>
</ol>

<p>Below you’ll find the relevant part of dovecot-sql.conf file regarding our
setup.</p>

<p>Things you will probably need to change are db connection settings (connect=)
and the default_pass_scheme.</p>

<p>#BEGIN /etc/dovecot/dovecot-sql.conf</p>

<p>connect = host=localhost dbname=postfix user=postfix password=postfix</p>
<h1 id="use-either">Use either</h1>
<p>driver = mysql</p>
<h1 id="or">Or</h1>
<h1 id="driver--pgsql">driver = pgsql</h1>

<h1 id="default-password-scheme---change-to-match-your-postfixadmin-setting">Default password scheme - change to match your Postfixadmin setting.</h1>
<h1 id="depends-on-your-confencrypt-setting">depends on your $CONF[‘encrypt’] setting:</h1>
<h1 id="md5crypt----md5-crypt">md5crypt  -&gt; MD5-CRYPT</h1>
<h1 id="md5---------plain-md5">md5       -&gt; PLAIN-MD5</h1>
<h1 id="cleartext---plain">cleartext -&gt; PLAIN</h1>
<p>default_pass_scheme = MD5-CRYPT</p>

<h1 id="query-to-retrieve-password-user-can-be-used-to-retrieve-username-in-other">Query to retrieve password. user can be used to retrieve username in other</h1>
<h1 id="formats-also">formats also.</h1>

<p>password_query = SELECT username AS user,password FROM mailbox WHERE username = ‘%u’ AND active=’1’</p>

<h1 id="query-to-retrieve-user-information-note-uid-matches-dovecotconf-and-postfix-virtual_uid_maps-parameter">Query to retrieve user information, note uid matches dovecot.conf AND Postfix virtual_uid_maps parameter.</h1>
<p>user_query = SELECT maildir, 1001 AS uid, 1001 AS gid FROM mailbox WHERE username = ‘%u’ AND active=’1’</p>

<h1 id="mysql-">MYSQL :</h1>
<p>user_query = SELECT CONCAT(‘/var/vmail/mail/’, maildir) AS home, 1001 AS uid, 1001 AS gid, 
	CONCAT(‘*:bytes=’, quota) AS quota_rule FROM mailbox WHERE username = ‘%u’ AND active=’1’</p>
<h1 id="postgresql--no-quota-though-">PostgreSQL : (no Quota though) :</h1>
<h1 id="user_query--select-varvmailmail--maildir-as-home-1001-as-uid-1001-as-gid-from-mailbox-where-username--u-and-active--1">user_query = SELECT ‘/var/vmail/mail/’ || maildir AS home, 1001 as uid, 1001 as gid FROM mailbox WHERE username = ‘%u’ AND active = ‘1’</h1>

<p>#END /etc/dovecot/dovecot-sql.conf</p>

<ol>
  <li>
    <h2 id="dovecot-v10-quota-support-optional">Dovecot v1.0 quota support (optional)</h2>
  </li>
</ol>

<p>Please note that you need to use Dovecot’s own local delivery agent to
enforce and update quotas. Then you can view real-time used quotas in
Postfixadmin.</p>

<p>Add to dovecot.conf:</p>

<h2 id="imap-quota">IMAP quota</h2>
<p>protocol imap {
  quota = dict:storage=200000 proxy::quota
}</p>

<h2 id="pop-quota">POP quota</h2>
<p>protocol pop3 {
  mail_plugins = quota
}</p>

<h2 id="local-delivery-agent">Local Delivery Agent</h2>
<p>protocol lda {
  mail_plugins = quota
}</p>

<h2 id="dictionary-db-proxy">Dictionary DB proxy</h2>
<p>dict {
  quota = mysql:/etc/dovecot-dict-quota.conf
}</p>

<h2 id="default-quota-values">Default quota values</h2>
<p>plugin {
quota = dict:storage=200000 proxy::quota
}</p>

<p>Change dovecot-sql.conf to return quota values:</p>

<p>for MySQL:
user_query = SELECT maildir, 1001 AS uid, 1001 AS gid, CONCAT(‘dict:storage=’,floor(quota/1000),’ proxy::quota’) as quota FROM mailbox WHERE username = ‘%u’ AND active=’1’</p>

<p>for PostgreSQL:
user_query = SELECT maildir, 1001 AS uid, 1001 AS gid, ‘dict:storage=’ || floor(quota/1000) || ‘::proxy::quota’ as quota FROM mailbox WHERE username = ‘%u’ AND active=’1’</p>

<p>Create file dovecot-dict-quota.conf:</p>

<p>driver = mysql
connect = host=localhost dbname=postfix user=postfix password=postfix
default_pass_scheme = MD5-CRYPT
table = quota
select_field = current
where_field = path
username_field = username</p>

<p>Create database in Mysql:
(This is automatically done by postfixadmin’s setup.php)</p>

<p>Enable quota support in Postfixadmin config.inc.php:</p>

<p>$CONF[‘used_quotas’] = ‘YES’;
$CONF[‘quota’] = ‘YES’;</p>

<p>Note: The above text describes the configuration for dovecot 1.0 &amp; 1.1 quota table format.</p>

<p>If you use dovecot 1.2 or newer,</p>
<ul>
  <li>use the ‘quota2’ table (also created by setup.php)</li>
  <li>set $CONF[‘new_quota_table’] = ‘YES’</li>
</ul>

                    
                    
                </div>
            </div>
        </div>
        
        <footer>
            <p>&copy; PostfixAdmin.Team - PostfixAdmin is released under the <a href="https://github.com/postfixadmin/postfixadmin/blob/master/LICENSE.TXT">Various FOSS License</a></p>
        </footer>
    </div>
</body>
</html>

